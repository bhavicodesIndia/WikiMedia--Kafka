name: CI - Multi Module Spring Boot Kafka

on:
  push:
    branches: [main, master, wikimedia]
  pull_request:
    branches: [main, master, wikimedia]

jobs:
  build:
    name: Build & Verify Kafka Modules
    runs-on: ubuntu-latest

    # Optional: create temporary Kafka + MySQL services (for integration tests)
    services:
      zookeeper:
        image: bitnami/zookeeper:latest
        ports: ['2181:2181']
      kafka:
        image: bitnami/kafka:latest
        ports: ['9092:9092']
        env:
          KAFKA_CFG_ZOOKEEPER_CONNECT: 'zookeeper:2181'
          KAFKA_CFG_ADVERTISED_LISTENERS: 'PLAINTEXT://localhost:9092'
          KAFKA_CFG_LISTENERS: 'PLAINTEXT://:9092'
          ALLOW_PLAINTEXT_LISTENER: 'yes'
      mysql:
        image: mysql:8.0
        ports: ['3306:3306']
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wikimedia

    steps:
      # 1️⃣ Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Java 17 (same as your local dev setup)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 3️⃣ Wait for MySQL & Kafka to be ready (important for tests)
      - name: Wait for Kafka & MySQL services
        run: |
          echo "⏳ Waiting for Kafka & MySQL to start..."
          sleep 25

      # 4️⃣ Build all modules (parent pom + submodules)
      - name: Build and verify all modules
        run: mvn -B clean verify -DskipTests=false --file pom.xml

      # 5️⃣ Run module-level tests if needed
      - name: Run Producer tests
        run: mvn -B test --file kafka-producer/pom.xml

      - name: Run Consumer tests
        run: mvn -B test --file kafka-consumer/pom.xml

      # 6️⃣ Package both modules (ensures JARs exist)
      - name: Package artifacts
        run: mvn -B clean package -DskipTests=true --file pom.xml

      # 7️⃣ (Optional) Launch both apps for integration verification
      - name: Run Producer and Consumer temporarily
        run: |
          nohup java -jar kafka-producer/target/*.jar > producer.log 2>&1 &
          nohup java -jar kafka-consumer/target/*.jar > consumer.log 2>&1 &
          sleep 15
          echo "✅ Both apps started successfully"

      # 8️⃣ (Optional) Health check via actuator endpoints (if exposed)
      - name: Verify producer health
        run: curl --fail http://localhost:8080/actuator/health || exit 1

      - name: Verify consumer health
        run: curl --fail http://localhost:8081/actuator/health || exit 1

      # 9️⃣ Upload JARs as build artifacts
      - name: Upload JAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kafka-apps
          path: |
            kafka-producer/target/*.jar
            kafka-consumer/target/*.jar
